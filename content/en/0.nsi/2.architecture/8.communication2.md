---
title: Communication Protocols
navigation: false
description: "Experimenting with communication protocols using micro:bit cards: understand why and how to structure information exchanges to make messages understandable and usable."
links:
- label: 'Page 1'
  icon: 'i-lucide-circle'
  to: '/nsi/architecture/communication'
---

::tip
How do two computers communicate?
::

::steps{level="3"}

### Base code
::note
This code only allows exchanging messages by radio. It has major problems:
- everything is unintelligible
- we don't know who is the recipient or sender
::
```py
from microbit import *
import radio

radio.on()  # Activate radio
radio.config(channel=10)  # Set a channel (10 here)

while True:
    if button_a.was_pressed():
        msg_send = input("Message?")
        radio.send(msg_send)  # Send a message
    message = radio.receive() # Check regularly for message reception
    if message:
        print(message)  # Display received message in console
```

### Protocol definition
::note
**Version 1**
- The separator used is the *generic currency symbol* `¤`
- The frame is defined as: `RECIPIENT¤SENDER¤MESSAGE`
- The recipient, sender and message cannot be empty
- `ping` is a reserved name
- We ignore messages that don't follow this protocol
::

### Protocol implementation
::note
We add the following elements:
- constants: `SEP` for separator, `PSEUDO` for sender name
- use of `input()` function to enter recipient's pseudo
- concatenation of strings needed to create the frame
- we ignore messages that don't follow the protocol:
    - use `split()` to divide received message
    - if we get three parts, we consider first is recipient, second is sender, third is message
    - each of the three parts must not equal empty string `''`
::

```py {6-7,13-14, 18-20}
from microbit import *
import radio

radio.on()  # Activate radio
radio.config(channel=10)  # Set a channel (10 here)
SEP = '¤'
PSEUDO = 'Mathieu'

while True:
    if button_a.was_pressed():
        msg_send = input("Message?")
        recipient = input("Recipient?")
        radio.send(recipient+SEP+PSEUDO+SEP+msg_send)  # Send a message

    frame = radio.receive() # Check regularly for message reception
    if frame:
        parts = frame.split(SEP)
        if len(parts) == 3 and parts[0] != '' and parts[1] != '' and parts[2] != '':
            print(parts[2])
```

### Display messages that concern us
::note
We don't want to pollute our display with messages not addressed to us.
So we define our username, and only display messages addressed to us.
::

```py {20-21}
from microbit import *
import radio

radio.on()  # Activate radio
radio.config(channel=10)  # Set a channel (10 here)
SEP = '¤'
PSEUDO = 'Mathieu'

while True:
    if button_a.was_pressed():
        msg_send = input("Message?")
        recipient = input("Recipient?")
        radio.send(recipient+SEP+PSEUDO+SEP+msg_send)  # Send a message

    frame = radio.receive() # Check regularly for message reception
    if frame:
        parts = frame.split(SEP)
        if len(parts) == 3 and parts[0] != '' and parts[1] != '' and parts[2] != '':
            if parts[0] == PSEUDO:
                print(parts[2])
```

### Signal presence on network (WIP)
::note
We currently send messages to people within voice range, who can give us their network pseudonym information. We'll add functionality to signal presence on the network, using a **command** we'll call `ping`.
<br>
"Sending a ping" means sending a frame to recipient `ping`, with message corresponding to our `pseudo`.
::

::warning
This means `ping` becomes a **reserved name**: its use as pseudonym must be forbidden.
::

```py {15-16}
from microbit import *
import radio

radio.on()  # Activate radio
radio.config(channel=10)  # Set a channel (10 here)
SEP = '¤'
PSEUDO = 'Mathieu'

while True:
    if button_a.was_pressed():
        msg_send = input("Message?")
        dest = input("Recipient?")
        radio.send(dest+SEP+PSEUDO+SEP+msg_send)  # Send a frame

    if button_b.was_pressed():
        radio.send('ping'+SEP+PSEUDO)  # Send ping to signal presence

    frame = radio.receive() # Check regularly for message reception
    if frame:
        parts = frame.split(SEP)
        if len(parts) == 3 and parts[0] != '' and parts[1] != '' and parts[2] != '':
            if parts[0] == PSEUDO:
                print(parts[2])
```

### Handle pings from others
::note
We must handle `ping` and add the identifier that signaled to us to a list, for easier use.
::

::tip
We use a **dictionary** to store pseudos, because a dictionary, by design, cannot have two identical keys. This allows us:
- to avoid duplicates
- to store a value associated with each pseudo (useful later)
::

```py {9, 19, 24-25}
from microbit import *
import radio

radio.on()  # Activate radio
radio.config(channel=10)  # Set a channel (10 here)
SEP = '¤'
PSEUDO = 'Mathieu'

directory = {}

while True:
    if button_a.was_pressed():
        msg_send = input("Message?")
        dest = input("Recipient?")
        radio.send(dest+SEP+PSEUDO+SEP+msg_send)  # Send a frame

    if button_b.was_pressed():
        radio.send('ping'+SEP+PSEUDO)  # Send ping to signal presence
        print(directory)

    frame = radio.receive() # Check regularly for message reception
    if frame:
        parts = frame.split(SEP)
        if len(parts) == 2 and parts[0] == 'ping' and parts[1] != '':
            directory[parts[1]] = 'toto'

        if len(parts) == 3 and parts[0] != '' and parts[1] != '' and parts[2] != '':
            if parts[0] == PSEUDO:
                print(parts[2])
```

### Ping automation
::note
We'll use the `running_time()` function available on micro:bit cards, along with the modulo operator `%`.
::
::tip
Explanation of line `if running_time() % 5000 < 10`: <br>
- `running_time()` gives us milliseconds elapsed since micro:bit card startup
- `running_time() % 5000` gives us remainder of division by 5000
- if this remainder is less than `10ms`, then we just exceeded **5 seconds** less than **10 milliseconds** ago
<br>
This line allows us to activate ping sending every **5 seconds**
::

```py {12-14}
from microbit import *
import radio

radio.on()  # Activate radio
radio.config(channel=10)  # Set a channel (10 here)
SEP = '¤'
PSEUDO = 'Mathieu'

directory = {}

while True:
    if running_time() % 5000 < 10:
        radio.send('ping'+SEP+PSEUDO)
        sleep(10) # pause for 10ms to avoid sending ping multiple times at once

    if button_a.was_pressed():
        msg_send = input("Message?")
        dest = input("Recipient?")
        radio.send(dest+SEP+PSEUDO+SEP+msg_send)  # Send a frame

    if button_b.was_pressed():
        print(directory)

    frame = radio.receive() # Check regularly for message reception
    if frame:
        parts = frame.split(SEP)
        if len(parts) == 2 and parts[0] == 'ping' and parts[1] != '':
            directory[parts[1]] = 'toto'

        if len(parts) == 3 and parts[0] != '' and parts[1] != '' and parts[2] != '':
            if parts[0] == PSEUDO:
                print(parts[2])
```

### Recipient selection
::note
The dictionary created in step 6 contains pseudos of different users on the communication network. We can use this dictionary to allow choosing recipient from a list, rather than having to retype their pseudo each time.
::
::warning
Caution, depending on received `pings`, the user list will necessarily evolve over time. So it must be created from the dictionary each time we need to choose a user.
::

```py {11-15, 25}
from microbit import *
import radio

radio.on()  # Activate radio
radio.config(channel=10)  # Set a channel (10 here)
SEP = '¤'
PSEUDO = 'Mathieu'

directory = {}

def choose_recipient():
    users = { str(index): pseudo for index,pseudo in enumerate(directory)}
    print(users)
    choice = input("User?")
    return users[choice]

while True:
    if running_time() % 5000 < 10:
        radio.send('ping'+SEP+PSEUDO)
        sleep(10) # pause for 10ms to avoid sending ping multiple times at once

    if button_a.was_pressed():
        msg_send = input("Message?")
        dest = choose_recipient()
        radio.send(dest+SEP+PSEUDO+SEP+msg_send)  # Send a frame

    if button_b.was_pressed():
        print(directory)

    frame = radio.receive() # Check regularly for message reception
    if frame:
        parts = frame.split(SEP)
        if len(parts) == 2 and parts[0] == 'ping' and parts[1] != '':
            directory[parts[1]] = 'toto'

        if len(parts) == 3 and parts[0] != '' and parts[1] != '' and parts[2] != '':
            if parts[0] == PSEUDO:
                print(parts[2])
```